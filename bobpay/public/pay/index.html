<html>
<head>
<title>checkout-1</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body bgcolor="#efefef" width="412" style="margin: 0;" yahoo="yahoo">
<!-- Save for Web Slices (store-1.png) -->
<table id="Table_01" width="412" height="726" border="0" cellpadding="0" cellspacing="0">
<tr>
<td>
	<tr>
	<td>
			<a onclick="pay()">
			<img src="/images/checkout-1.png" width="412" border="0" alt=""></a></td>
	</tr>
</table>
<!-- End Save for Web Slices -->
    <script src="https://rawgit.com/apowers313/fido-local-server/master/fido-local-server.js"></script>
    <script>
    let paymentRequestClient;
    console.log ("setup");

    navigator.serviceWorker.addEventListener('message', e => {
      paymentRequestClient = e.source;
      document.getElementById('details').innerHTML = JSON.stringify(e.data, undefined, 2);
    });
    navigator.serviceWorker.controller.postMessage('payment_app_window_ready');

    function pay() {
      console.log ("pay");
      if(!paymentRequestClient) return;

      var authn = new WebAuthnTransaction();

      authn.authenticate()
        .then(() => {
          var paymentAppResponse = {
            methodName: "https://emerald-eon.appspot.com/bobpay",
            details: {
              id: "123456"
            }
          };

          paymentRequestClient.postMessage(paymentAppResponse);
          window.close();
        })
        .catch((e) => {
          // TODO: need to think about the error path here: retry? fail payment?
          console.log ("Authentication failed");
          console.log (e);
          throw e;
        });
    }

    function cancel() {
      console.log ("cancel");
      if(!paymentRequestClient) return;

      paymentRequestClient.postMessage("The payment request is cancelled by user");
      window.close();
    }
    </script>
</body>
</html>
